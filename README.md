# Проектная работа "Веб-ларёк"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```

## Данные и типы данных, используемые в приложении

Карточка

```
interface IProduct {
  id: string;
  category: string;
  image: string;
  price: number;
  title: string;
  description:string;
}
```

Пользователь

```
interface IUser {
	paymentMethod: string;
	address: string;
	email: string;
	phone: string;
}
```

Интерфейс для модели данных карточек товара

```
export interface ICatalogModel {
  items: IProduct[];
  setItems(items: IProduct[]): void;
  getProduct(id: string): IProduct;
}
```

Данные карточки, используемые в каталоге товаров

```
type TProductCatalogInfo = Pick<IProduct, 'category' | 'image' | 'price' | 'title'>;
```

Данные карточки, используемые в корзине

```
type TProductBasketInfo = Pick<IProduct, 'title' | 'price'>;
```

Данные пользователя в окне выбора способа оплаты и адреса доставки 

```
type TUserPaymentInfo = Pick<IUser, 'paymentMethod' | 'address'>;
```

Данные пользователя в окне ввода почты и телефона

```
type TUserContactInfo = Pick<IUser, 'email' | 'phone'>;
```

Данные заказа для отправки на сервер

```
type TOrder = IUser & {
  total: string; 
  items: string[];
};
```


## Архитектура приложения

Код приложения разделен на слои согласно парадигме MVP: 
- слой представления, отвечает за отображение данных на странице, 
- слой данных, отвечает за хранение и изменение данных
- презентер, отвечает за связь представления и данных.

### Базовый код

#### Класс Api
Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.
Методы: 
- `get` - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер
- `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

#### Класс EventEmitter
Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.  
Основные методы, реализуемые классом описаны интерфейсом `IEvents`:
- `on` - подписка на событие
- `emit` - инициализация события
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие   


### Слой данных

#### Класс ProductsData
Класс отвечает за хранение и логику работы с данными карточек товаров.\
Конструктор класса принимает инстант брокера событий\
В полях класса хранятся следующие данные:
- _items: IProduct[] - массив объектов карточек товаров
- preview: string | null - id карточки товара, выбранной для просмотра в модальной окне
- events: IEvents - экземпляр класса `EventEmitter` для инициации событий при изменении данных
- inBasket(): boolean - признак нахождения в корзине

Так же класс предоставляет набор методов для взаимодействия с этими данными.
- setItems(items: IProduct[]): void - установка карточек после загрузки с сервера
- selectProduct(id: string): IProduct - возвращает карточку товара по ее id
- addToBasket(id: string): IProduct - добавляет товар в корзину

#### Класс UserData
Класс отвечает за хранение и логику работы с данными пользователя.\
Конструктор класса принимает инстант брокера событий\
В полях класса хранятся следующие данные:
- paymentMethod: string - способ оплаты товара
- address: string - адрес доставки товара
- email: string - электронная почта пользователя
- phone: string - телефон пользователя
- events: IEvents - экземпляр класса `EventEmitter` для инициации событий при изменении данных.

Так же класс предоставляет набор методов для взаимодействия с этими данными.
- getUserInfo(): TUserPublicInfo - возвращает данные введённые данные пользователя
- setUserInfo(userData: Partial<IUser>): void - сохраняет данные пользователя в объекте
- checkPaymentValidation(data: Record<keyof TUserPaymentInfo, string>): boolean - проверяет объект с данными об оплате на валидность
- checkContactsValidation(data: Record<keyof TUserContactInfo, string>): boolean - проверяет объект с данными пользователя на валидность
- clearData(): void - очишает данные пользователя в формах

#### Класс BasketModel
Класс отвечает за хранение и логику работы с товарами в корзине.\
Конструктор класса принимает список карточек и инстант брокера событий\
В полях класса хранятся следующие данные:
- items: IProduct[] | null - массив объектов карточек товаров
- totalCost: number - общая стоимость товаров

Так же класс предоставляет набор методов для взаимодействия с этими данными.
- getItems(items: IProduct[]): void - получение списка товаров в корзине
- add(item: IProduct): void  - добавляет карточку товара в корзину
- remove(id: string): void  - удаляет карточку товара из корзины
- getTotalCost(): number  - возвращает общую стоимость товаров
- countItems(): number - считает количество товаров в корзине


### Классы представления
Все классы представления отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных.

#### Базовый Класс Component
Класс является дженериком и родителем всех компонентов слоя представления. В дженерик принимает тип объекта, в котором данные будут передаваться в метод render для отображения данных в компоненте. \
В конструктор принимает элемент разметки, являющийся основным родительским контейнером компонента.\ 
Методы:
- render(data?: Partial<T>): HTMLElement  - отвечает за сохранение полученных в параметре данных в полях компонентов через их сеттеры, возвращает обновленный контейнер компонента.

#### Класс ProductsContainer
Отвечает за отображение блока с карточками на главной странице. В конструктор принимает контейнер, в котором размещаются карточки.

#### Класс Card
Отвечает за отображение карточки продукта на главном экране, задавая в карточке данные названия, изображения, категории и стоимости товара. Класс используется для отображения карточек на странице сайта.\ 
В конструктор класса передается DOM элемент темплейта и экземпляр `EventEmitter`. В классе устанавливается слушатель клика для генерарции события открытия модального окна карточки товара.\
Поля класса:
- category: HTMLSpanElement - элемент разметки с название категории
- image: HTMLImageElement - элемент разметки с изображением
- price: HTMLSpanElement - элемент разметки со стоимостью товара
- title: HTMLHeadingElement - элемент разметки с названием товара
- events: IEvents - экземпляр брокера событий

Методы отсутствуют.

#### Класс ModalWithProduct
Предназначен для реализации модального окна карточки с описанием товара. При открытии модального окна получает все данные товара.\
Конструктор принимает селектор, по которому в разметке страницы будет идентифицировано модальное окно и экземпляр класса `EventEmitter` для возможности инициации событий.\
Поля класса:
- category: HTMLSpanElement - элемент разметки с название категории
- image: HTMLImageElement - элемент разметки с изображением
- price: HTMLSpanElement - элемент разметки со стоимостью товара
- title: HTMLHeadingElement - элемент разметки с названием товара
- description: HTMLParagraphElement - элемент разметки с описанием товара
- buyButton: HTMLButtonElement - Кнопка добавления товара в корзину
- closeButton: HTMLButtonElement - Кнопка закрытия модального окна
- events: IEvents - экземпляр брокера событий

Методы:
- open(): void - открывает модальное окно
- buy(item: IProduct): void - добавляет продукт в корзину
- close(): void - закрывает модальное окно

#### Класс ModalWithBasket 
Предназначен для реализации  модального окна корзины с товарами.  При открытии модального окна отображает список товаров добавленных в корзину.
Конструктор принимает селектор, по которому в разметке страницы будет идентифицировано модальное окно, элемент списка корзины и экземпляр класса `EventEmitter` для возможности инициации событий.\ 
Поля класса:
- modal: HTMLElement - элемент модального окна
- basketList: HTMLUListElement - элемент списка товаров
- deleteButton: HTMLButtonElement - кнопка удаления товара
- submitButton: HTMLButtonElement - кнопка оформления заказа
- closeButton: HTMLButtonElement - кнопка закрытия модального окна
- events: IEvents - экземпляр брокера событий

Методы:
- confirm(): void - оформляет заказ
- add(item: IProduct): void - принимает данные товара для добавления в спиок товаров корзины
- remove(): void - удаляет товар корзины
- open(): void - открывает модальное окно
- close(): void - закрывает модальное окно

#### Класс ModalPayment 
Предназначен для реализации модального окна с формой для ввода методом оплаты и доставки товара.\
Конструктор принимает селектор, по которому в разметке страницы будет идентифицировано модальное окно и экземпляр класса `EventEmitter` для возможности инициации событий.\
Поля класса:
- paymentType: string;
- _form: HTMLFormElement - элемент формы
- closeButton: HTMLButtonElement - кнопка закрытия модального окна
- submitButton: HTMLButtonElement - кнопка подтверждения
- input: HTMLInputElement - элемент поля ввода адреса
- error: HTMLSpanElement - элемент для вывода ошибок заполнения формы
- events: IEvents - экземпляр брокера событий

Методы:
- setValid(isValid: boolean): void - изменяет активность кнопки подтверждения
- getInputValues(): Record<string, string> - возвращает объект с данными из полей формы, где ключ - name инпута, значение - данные введенные пользователем
- setInputValues(data: Record<string, string>): void - принимает объект с данными для заполнения полей формы
- setError(data: { field: string, value: string, validInformation: string }): void - принимает объект с данными для отображения или сокрытия текстов ошибок под полями ввода
- get form: HTMLElement - геттер для получения элемента формы
- showInputError(field: string, errorMessage: string) - показывает ошибку ввода данных
- hideInputError(field: string)  - скрывает ошибку ввода данных
- open(): void - открывает модальное окно
- close(): void - закрывает модальное окно

#### Класс ModalContacts
Предназначен для реализации модального окна с формой для ввода электронной почты и телефона пользователя.\
Конструктор принимает селектор, по которому в разметке страницы будет идентифицировано модальное окно и экземпляр класса `EventEmitter` для возможности инициации событий.\
Поля класса:
- _form: HTMLFormElement - элемент формы
- closeButton: HTMLButtonElement - кнопка закрытия модального окна
- submitButton: HTMLButtonElement - кнопка оплаты
- inputs: NodeListOf<HTMLInputElement> - коллекция всех полей ввода формы
- error: HTMLSpanElement - элемент для вывода ошибок заполнения формы
- events: IEvents - экземпляр брокера событий

Методы:
- setValid(isValid: boolean): void - изменяет активность кнопки подтверждения
- getInputValues(): Record<string, string> - возвращает объект с данными из полей формы, где ключ - name инпута, значение - данные введенные пользователем
- setInputValues(data: Record<string, string>): void - принимает объект с данными для заполнения полей формы
- setError(data: { field: string, value: string, validInformation: string }): void - принимает объект с данными для отображения или сокрытия текстов ошибок под полями ввода
- get form: HTMLElement - геттер для получения элемента формы
- showInputError(field: string, errorMessage: string) - показывает ошибку ввода данных
- hideInputError(field: string)  - скрывает ошибку ввода данных
- sendOrder(data: TOrder): {id: string, total: number} - отправляет заказ на сервер
- open(): void - открывает модальное окно
- close(): void - закрывает модальное окно

#### Класс OrderSuccess 
Предназначен для реализации модального окна с информацией об успешном оформлении заказа.\
Конструктор принимает селектор, по которому в разметке страницы будет идентифицировано модальное окно и экземпляр класса `EventEmitter` для возможности инициации событий.\
Поля класса:
- orderCost: number - стоимость заказа
- closeButton: HTMLButtonElement - кнопка закрытия модального окна
- successButton: HTMLButtonElement - кнопка "За новыми покупками!" закрывает модальное окно

Методы:
- open(): void - открывает модальное окно
- close(): void - закрывает модальное окно
- сеттер для записи стоимости заказа


### Слой презентера

#### Класс AppApi
Принимает в конструктор экземпляр класса Api и предоставляет методы реализующие взаимодействие с бэкендом сервиса.
Методы:
- getCards(): Promise<IProduct[]> - получение массива карточек товаров с сервера
- sendOrder(TOrder): {id: string, total: number} - отправка заказа на сервер

#### Взаимодействие компонентов
Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.\
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

*Список всех событий, которые могут генерироваться в системе:*\
*События изменения данных (генерируются классами моделями данных)*
- `cards:load` - загрузка массива карточек товаров с сервера
- `basket:changed` - изменение состава корзины
- `user:changed` - изменение данных пользователя
- `order:success` - получение ответа об успешном заказе от сервера и очистка карзины


*События, возникающие при взаимодействии пользователя с интерфейсом (генерируются классами, отвечающими за представление)*
- `product:open` - открытие модального окна с описанием продукта
- `basket:open` - открытие модального окна корзины
- `payment:open` - открытие модального окна с формой ввода способа оплаты и адреса
- `contacts:open` - открытие модального окна с формой ввода электронной почты и телефона
- `basket:add` - добавление товара в корзину
- `basket:remove` - удаление товара из корзины
- `edit-payment:input` - изменение данных в форме способа оплаты и адреса
- `edit-contacts:input` - изменение данных в форме электронной почты и телефона
- `edit-payment:submit` - сохранение способа оплаты и адреса пользователя в модальном окне
- `edit-contacts:submit` - сохранение электронной почты и телефона пользователя в модальном окне

Пример работы презентера:
1. Пользователь нажимает иконку удаления товара из корзины: в классе ModalWithBasket срабатывает метод remove() и генерирует событие emit(`basket:remove`, ...).
2. В файле презентера `index.ts` срабатывает событие on(`avatar:open`, ...) и в классе BasketModel вызывается метод remove(). 
3. В классе BasketModel выполняется удаление элемента из массива (поле items), выполняется перерасчёт количества товаров и суммы (методы getTotalCost() и countItems(), после чего генерируется событие emit(`basket:changed`, ...) с новыми данными.
4. В файле презентера обрабатывается событие on(`basket:changed`, ...) и вызывается метод render класса расширения Component.
5. Представление модального окна класса ModalWithBasket перерисовывается с новми данными.
