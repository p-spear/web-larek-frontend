# Проектная работа "Веб-ларёк"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом
- src/components/Model/ — папка с кодом компонентов моделей данных
- src/components/View/ — папка с кодом компонентов представлений

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```

## Данные и типы данных, используемые в приложении

Карточка

```
interface IProduct {
  id: string;
  category: string;
  image: string;
  price: number;
  title: string;
  description:string;
}
```

Пользователь

```
interface IUser {
	paymentMethod: string;
	address: string;
	email: string;
	phone: string;
}
```

Интерфейс для модели данных карточек товара

```
interface ICatalogData {
  setItems(items: IProduct[]): void;
  getProduct(itemId: string): IProduct;
}
```

Интерфейс для формы первого шага оформления заказа

```
interface IOrderForm {
    payment: string;
    address: string;
}
```

Интерфейс для формы второго шага оформления заказа

```
interface IContactsForm {
    email: string;
    phone: string;
}
```

Интерфейс модели данных запроса на сервер для оформления заказа

```
interface IOrderBasketData {
  total: number; 
  items: string[];
}
```

Интерфейс модели данных успешного ответа от сервера после оформления заказа

```
interface IOrderResult  {
  id: string, 
  total: number
}
```

Интерфейс модели данных для отправки и получения данных сервера

```
interface IApi {
    baseUrl: string;
    get<T>(uri: string): Promise<T>;
    post<T>(uri: string, data: object, method?: ApiPostMethods): Promise<T>;
}
```

Тип данных для маппинга полей ввода и теста ошибок в форме первого шага оформления заказа

```
type OrderFormErrors = Partial<Record<keyof IOrderForm, string>>;
```

Тип данных для маппинга полей ввода и теста ошибок в форме второго шага оформления заказа

```
type ContactsFormErrors = Partial<Record<keyof IContactsForm, string>>;
```

Тип данных возможных методов api 

```
type ApiPostMethods = 'POST' | 'PUT' | 'DELETE';
```

Данные заказа для отправки на сервер

```
type TOrderData = IUser & IOrderBasketData;
```


## Архитектура приложения

Код приложения разделен на слои согласно парадигме MVP: 
- слой представления, отвечает за отображение данных на странице, 
- слой данных, отвечает за хранение и изменение данных
- презентер, отвечает за связь представления и данных.

### Базовый код

#### Класс Api
Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.
Методы: 
- `get` - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер
- `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

#### Класс EventEmitter
Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.  
Основные методы, реализуемые классом описаны интерфейсом `IEvents`:
- `on` - подписка на событие
- `emit` - инициализация события
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие   


### Слой данных

#### Класс ProductsData
Класс отвечает за хранение и логику работы с данными карточек товаров.\
Конструктор класса принимает инстант брокера событий\
В полях класса хранятся следующие данные:
- items: IProduct[] - массив объектов карточек товаров
- events: IEvents - экземпляр класса `EventEmitter` для инициации событий при изменении данных

Так же класс предоставляет набор методов для взаимодействия с этими данными.
- setItems(items: IProduct[]): void - записывает карточки после загрузки с сервера
- getItems(): IProduct[] -  возвращает карточку товара по ее id
- getProduct(id: string): IProduct - получение выбранной карточки товара

#### Класс UserData
Класс отвечает за хранение и логику работы с данными пользователя.\
Конструктор класса принимает инстант брокера событий\
В полях класса хранятся следующие данные:
- payment: string - способ оплаты товара
- address: string - адрес доставки товара
- email: string - электронная почта пользователя
- phone: string - телефон пользователя
- events: IEvents - экземпляр класса `EventEmitter` для инициации событий при изменении данных

Так же класс предоставляет набор методов для взаимодействия с этими данными.
- getUserInfo(): IUser - возвращает данные пользователя
- setUserInfo(field: keyof IUser, value: string): void - сохраняет данные пользователя в объекте
- validateOrder(): void - проверяет поля ввода первого шага оформления заказа на валидность
- validateContacts(): void - проверяет поля ввода второго шага оформления заказа на валидность
- clearData(): void - очишает данные пользователя в формах

#### Класс BasketData
Класс отвечает за хранение и логику работы с товарами в корзине.\
Конструктор класса принимает список карточек и инстант брокера событий\
В полях класса хранятся следующие данные:
- items: IProduct[] - массив объектов карточек товаров
- events: IEvents - экземпляр класса `EventEmitter` для инициации событий при изменении данных

Так же класс предоставляет набор методов для взаимодействия с этими данными.
- getItems(): IProduct[] - получение списка товаров в корзине
- inBasket(cardId: string): boolean - проверяет наличие товара в корзине
- add(item: IProduct): void  - добавляет карточку товара в корзину
- remove(id: string): void  - удаляет карточку товара из корзины
- setTotalCost(total: number) - сохраняет общую стоимость товаров
- getTotalCost(): number  - возвращает общую стоимость товаров
- countItems(): number - считает количество товаров в корзине
- getOrderData(): IOrderBasketData - получение данных для отправки заказа
- clearBasket(): void - очищает корзину

### Классы представления
Все классы представления отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных.

#### Базовый Класс Component
Абстрактный класс является дженериком и родителем всех компонентов слоя представления. В дженерик принимает тип объекта, в котором данные будут передаваться в метод render для отображения данных в компоненте. \
В конструктор принимает элемент разметки, являющийся основным родительским контейнером компонента.\ 
Методы:
- render(data?: Partial<T>): HTMLElement  - отвечает за сохранение полученных в параметре данных в полях компонентов через их сеттеры, возвращает обновленный контейнер компонента.
- toggleClass(element: HTMLElement, className: string, force?: boolean) - переключает класс элементу разметки
- setText(element: HTMLElement, value: unknown) - устанавливает текстовое содержимое элементу разметки
- setDisabled(element: HTMLElement, state: boolean) - меняет статус блокировки элементу разметки
- setHidden(element: HTMLElement) - скрывает элемент разметки
- setVisible(element: HTMLElement) - отображает элемент разметки
- setImage(element: HTMLImageElement, src: string, alt?: string) - устанавливает изображение с алтернативным текстом
- render(data?: Partial<T>): HTMLElement - возвращает корневой элемент разметки

#### Класс CardProduct
Отвечает за отображение содержимого карточки с описанием товара, задавая в карточке данные названия, изображения, категории, стоимости и описания товара.\
В конструктор класса передается DOM элемент темплейта и экземпляр `EventEmitter` для инициации событий. В классе устанавливается слушатель клика на кнопку добавления в корзину.\
Поля класса:
- events: IEvents - экземпляр брокера событий
- category: HTMLSpanElement - элемент разметки с название категории
- image: HTMLImageElement - элемент разметки с изображением
- price: HTMLSpanElement - элемент разметки со стоимостью товара
- title: HTMLHeadingElement - элемент разметки с названием товара
- description: HTMLParagraphElement - элемент разметки с описанием товара
- buyButton: HTMLButtonElement - кнопка добавления товара в корзину

Методы:
- сеттеры для полей класса
- isValid(isValid: boolean): void - в зависимости от стоимости товара делает кнопку недоступной 

#### Класс CardCatalog 
Отвечает за отображение карточки продукта на главном экране, задавая в карточке данные названия, изображения, категории и стоимости товара. Класс используется для отображения карточек в каталоге.\ 
В конструктор класса передается DOM элемент темплейта и экземпляр `EventEmitter` для инициации событий. В классе устанавливается слушатель клика для генерарции события открытия модального окна карточки товара.\
Поля класса:
- events: IEvents - экземпляр брокера событий
- category: HTMLSpanElement - элемент разметки с название категории
- image: HTMLImageElement - элемент разметки с изображением
- price: HTMLSpanElement - элемент разметки со стоимостью товара
- title: HTMLHeadingElement - элемент разметки с названием товара
- cardId: string - id карточки товара

Методы:
- сеттеры для полей класса

#### Класс CardBasket
Отвечает за отображение карточки в корзине, задавая в карточке данные названия и цены.
В конструктор класса передается DOM элемент темплейта и экземпляр `EventEmitter` для инициации событий. В классе устанавливается слушатель клика на кнопке удаления товара.\
- events: IEvents - экземпляр брокера событий
- _index: HTMLSpanElement - элемент разметки с индексом товара
- _title: HTMLHeadingElement - элемент разметки с названием товара
- _price: HTMLSpanElement - элемент разметки со стоимостью товара
- deleteButton: HTMLButtonElement - кнопка удаления товара

Методы:
- сеттеры для полей класса
- setIndex(value: number) - записывает индекс товара в корзине

#### Класс Page
Отвечает за отображение главной страницы.
В конструктор принимает элемент разметки, являющийся основным родительским контейнером страницы и экземпляр `EventEmitter`. В классе устанавливается слушатель клика для генерарции событий открытия модального окна корзины.\
Поля класса:
- _wrapper: HTMLElement - родительский элемент главной страницы
- _catalog: HTMLElement - контейнер для отображения карточек товаров
- _basket: HTMLButtonElement - кнопка открытия модального окна корзины
- _counter: HTMLSpanElement - элемент разметки с количеством товаров в корзине

Методы:
- set counter(value: number): void - сеттер для обновления счётчика
- set catalog(items: HTMLElement[]): void - сеттер для отрисовки карточек с сервера
- set locked(value: boolean): void - сеттер для блокировки страницы при открытии модального окна

#### Класс Modal
Предназначен для реализации модального окна, в которое может быть выведен любой контент. 
Конструктор принимает селектор, по которому в разметке страницы будет идентифицировано модальное окно и экземпляр класса `EventEmitter` для возможности инициации событий. В классе устанавливается слушатель клика на кнопку закрытия.\
Поля класса:
- closeButton: HTMLButtonElement - кнопка закрытия модального окна
- content: HTMLElement - элемент разметки, который нужно отобразить в модальном окне

Методы:
- open(): void - открывает модальное окно
- close(): void - закрывает модальное окно
- render(data: IModalData): HTMLElement - расширяет родительский метод дополнительно вызывая открытие модального окна

#### Класс Basket 
Предназначен для отображения содержимого шаблона корзины.\
Конструктор принимает DOM элемент темплейта корзины и экземпляр класса `EventEmitter` для инициации событий. В классе устанавливается слушатель клика на кнопку оформления.\ 
Поля класса:
- _list: HTMLUListElement - элемент разметки списка товаров
- _total: HTMLSpanElement - элемент разметки общей стоимости товаров
- submitButton: HTMLButtonElement - кнопка оформления заказа

Методы:
- set items(items: HTMLElement[]): void - вставляет в разметку массив карточек или выводит текст 'Корзина пуста'
- set total(total: number): void - вставляетв разметку общую стоимость товаров

#### Класс Form
Родительский класс для экранов форм. Предназначен для реализации формы, в которое может быть выведен любой контент.\
Конструктор принимает селектор, по которому в разметке страницы будет идентифицировано сордержимое формы и экземпляр класса `EventEmitter` для возможности инициации событий. В классе устанавливаются слушатели на поля ввода и на метод `submit`.\
Поля класса:
- _submit: HTMLButtonElement - кнопка подтверждения
- _errors: HTMLElement - элемент разметки, для вывода ошибок заполнения полей ввода

Методы:
- onInputChange(field: keyof T, value: string) - передаёт введёное значение в модель данных
- set valid(value: boolean) - отвечает за доступность кнопки подтверждения
- set errors(value: string) - отображает ошибки заполнения полей ввода
- render(state: Partial<T> & IFormState): HTMLElement - расширяет родительский метод дополнительно отображая значения полей ввода и ошибки

#### Класс Order 
Предназначен для отображения содержимого шаблона формы для ввода метода оплаты и адреса доставки товара.\
Конструктор принимает DOM элемент темплейта формы для ввода метода оплаты и адреса доставки товара, а так же экземпляр класса `EventEmitter` для инициации событий. В классе устанавливаются слушатели на кнопки способа оплаты.\ 
Поля класса:
- cardButton: HTMLButtonElement - кнопка выбора онлайн оплаты
- cardButton: HTMLButtonElement - кнопка выбора оплаты наличными

Методы:
- set address(value: string): void - сеттер записывает в элемент разметки значение адреса
- setPayment(buttons: NodeListOf<Element>, target: HTMLInputElement) - реализует выбор способа оплаты
- clearPayment():void - очищает значение способа оплаты

#### Класс Contacts
Предназначен для отображения содержимого шаблона формы для ввода электронной почты и телефона пользователя.\
Конструктор принимает DOM элемент темплейта формы для ввода электронной почты и телефона пользователя, а так же экземпляр класса `EventEmitter` для инициации событий.\ 

Методы:
- set email(value: string): void - сеттер записывает в элемент разметки значение электронной почты
- set phone(value: string): void - сеттер записывает в элемент разметки значение телефона

#### Класс OrderSuccess 
Предназначен для отображения содержимого шаблона успешного оформления заказа.\
Конструктор принимает DOM элемент темплейта успешного оформления заказа и callback-функцию для кнопки. В классе устанавливается слушатель на кнопку успешного оформления заказа.\ 
Поля класса:
- _close: HTMLButtonElement -  кнопка "За новыми покупками!" закрывает модальное окно
- _total: HTMLParagraphElement - элемент разметки общей стоимости заказа

Методы:
- set total(value: number): void - сеттер записывает в элемент разметки общую стоимости заказа


### Слой презентера

#### Класс AppApi
Принимает в конструктор экземпляр класса Api и предоставляет методы реализующие взаимодействие с бэкендом сервиса.
Методы:
- getCards(): Promise<IProduct[]> - получение массива карточек товаров с сервера
- sendOrder(TOrder): {id: string, total: number} - отправка заказа на сервер

#### Взаимодействие компонентов
Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.\
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

*Список всех событий, которые могут генерироваться в системе:*\
*События изменения данных (генерируются классами моделями данных)*
- `basket:changed` - изменение состава корзины
- `input:change` - сохранение данных пользователя в модели
- `contacts:submit` - отправка заказа на сервер, очищение корзины и данных пользователя

*События, возникающие при взаимодействии пользователя с интерфейсом (генерируются классами, отвечающими за представление)*
- `cards:load` - загрузка массива карточек товаров с сервера
- `card:select` - выбор карточки продукта
- `basket:open` - открытие модального окна корзины
- `basket:add` - добавление товара в корзину
- `basket:remove` - удаление товара из корзины
- `basket:submit` - открытие формы первого шага оформления заказа (способа оплаты и адреса)
- `order:submit` - открытие формы второго шага оформления заказа (электронной почты и телефона)
- `orderFormErrors:change` - отображение ошибок ввода на первом шаге оформления заказа
- `contactsFormErrors:change` - отображение ошибок ввода на втором шаге оформления заказа
- `modal:open` - открытие модального окна
- `modal:close` - закрытие модального окна

Пример работы презентера:
1. Пользователь нажимает иконку удаления товара из корзины: в классе CardBasket срабатывает метод слушатель на элементе deleteButton и генерирует событие emit(`basket:remove`, ...).
2. В файле презентера `index.ts` срабатывает событие on(`basket:remove`, ...) и в классе BasketData вызывается метод remove(). 
3. В классе BasketData выполняется удаление элемента из массива (поле _items), после чего генерируется событие emit(`basket:changed`, ...) с новыми данными.
4. В файле презентера обрабатывается событие on(`basket:changed`, ...) и вызывается в классе Component метод render(родительский класс CardBasket).
5. Представление модального окна корзины перерисовывается с новми данными.
