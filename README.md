# Проектная работа "Веб-ларёк"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```

## Данные и типы данных, используемые в приложении

Карточка

```
interface IProduct {
  id: string;
  category: string;
  image: string;
  price: number;
  title: string;
  description:string;
}
```

Пользователь

```
interface IUser {
	paymentMethod: string;
	address: string;
	email: string;
	phone: string;
}
```

Интерфейс для модели данных карточек товара

```
export interface ICatalogModel {
  items: IProduct[];
  setItems(items: IProduct[]): void;
  getProduct(id: string): IProduct;
}
```

Данные карточки, используемые в каталоге товаров

```
type TProductCatalogInfo = Pick<IProduct, 'category' | 'image' | 'price' | 'title'>;
```

Данные карточки, используемые в корзине

```
type TProductBasketInfo = Pick<IProduct, 'title' | 'price'>;
```

Данные пользователя в окне выбора способа оплаты и адреса доставки 

```
type TUserPaymentInfo = Pick<IUser, 'paymentMethod' | 'address'>;
```

Данные пользователя в окне ввода почты и телефона

```
type TUserContactInfo = Pick<IUser, 'email' | 'phone'>;
```

Данные заказа для отправки на сервер

```
type TOrder = IUser & {
  total: string; 
  items: string[];
};
```


## Архитектура приложения

Код приложения разделен на слои согласно парадигме MVP: 
- слой представления, отвечает за отображение данных на странице, 
- слой данных, отвечает за хранение и изменение данных
- презентер, отвечает за связь представления и данных.

### Базовый код

#### Класс Api
Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.
Методы: 
- `get` - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер
- `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

#### Класс EventEmitter
Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.  
Основные методы, реализуемые классом описаны интерфейсом `IEvents`:
- `on` - подписка на событие
- `emit` - инициализация события
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие   


### Слой данных

#### Класс ProductsData
Класс отвечает за хранение и логику работы с данными карточек товаров.\
Конструктор класса принимает инстант брокера событий\
В полях класса хранятся следующие данные:
- _items: IProduct[] - массив объектов карточек товаров
- preview: string | null - id карточки товара, выбранной для просмотра в модальной окне
- events: IEvents - экземпляр класса `EventEmitter` для инициации событий при изменении данных

Так же класс предоставляет набор методов для взаимодействия с этими данными.
- setItems(items: IProduct[]): void - установка карточек после загрузки с сервера
- getProduct(id: string): IProduct - возвращает карточку товара по ее id
- set preview(cardId: string | null): void - сеттер для поля выбранной карточки товара

#### Класс UserData
Класс отвечает за хранение и логику работы с данными пользователя.\
Конструктор класса принимает инстант брокера событий\
В полях класса хранятся следующие данные:
- paymentMethod: string - способ оплаты товара
- address: string - адрес доставки товара
- email: string - электронная почта пользователя
- phone: string - телефон пользователя
- events: IEvents - экземпляр класса `EventEmitter` для инициации событий при изменении данных.

Так же класс предоставляет набор методов для взаимодействия с этими данными.
- getUserInfo(): IUser - возвращает данные пользователя
- setUserInfo(userData: Partial<IUser>): void - сохраняет данные пользователя в объекте
- checkPaymentValidation(data: Record<keyof TUserPaymentInfo, string>): boolean - проверяет объект с данными об оплате на валидность
- checkContactsValidation(data: Record<keyof TUserContactInfo, string>): boolean - проверяет объект с данными пользователя на валидность
- clearData(): void - очишает данные пользователя в формах

#### Класс BasketModel
Класс отвечает за хранение и логику работы с товарами в корзине.\
Конструктор класса принимает список карточек и инстант брокера событий\
В полях класса хранятся следующие данные:
- items: IProduct[] | null - массив объектов карточек товаров
- totalCost: number - общая стоимость товаров

Так же класс предоставляет набор методов для взаимодействия с этими данными.
- getItems(items: IProduct[]): void - получение списка товаров в корзине
- add(item: IProduct): void  - добавляет карточку товара в корзину
- remove(id: string): void  - удаляет карточку товара из корзины
- getTotalCost(): number  - возвращает общую стоимость товаров
- countItems(): number - считает количество товаров в корзине


### Классы представления
Все классы представления отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных.

#### Базовый Класс Component
Абстрактный класс является дженериком и родителем всех компонентов слоя представления. В дженерик принимает тип объекта, в котором данные будут передаваться в метод render для отображения данных в компоненте. \
В конструктор принимает элемент разметки, являющийся основным родительским контейнером компонента.\ 
Методы:
- render(data?: Partial<T>): HTMLElement  - отвечает за сохранение полученных в параметре данных в полях компонентов через их сеттеры, возвращает обновленный контейнер компонента.
- toggleClass(element: HTMLElement, className: string, force?: boolean) - переключает класс элементу разметки
- setText(element: HTMLElement, value: unknown) - устанавливает текстовое содержимое элементу разметки
- setDisabled(element: HTMLElement, state: boolean) - меняет статус блокировки элементу разметки
- setHidden(element: HTMLElement) - скрывает элемент разметки
- setVisible(element: HTMLElement) - отображает элемент разметки
- setImage(element: HTMLImageElement, src: string, alt?: string) - устанавливает изображение с алтернативным текстом

#### Класс Page
Отвечает за отображение главной страницы.
В конструктор принимает элемент разметки, являющийся основным родительским контейнером страницы и экземпляр `EventEmitter`. В классе устанавливается слушатель клика для генерарции событий открытия модального окна карточки товара и корзины.\
Поля класса:
- wrapper: HTMLElement - родительский элемент главной стриницы
- catalog: HTMLElement - контейнер для отображения карточек товаров
- basket: HTMLButtonElement - кнопка открытия модального окна корзины
- counter: HTMLSpanElement - элемент разметки с количеством товаров в корзине

Методы:
- set counter(value: number): void - сеттер для обновления счётчика
- set catalog(items: HTMLElement[]): void - сеттер для отрисовки карточек с сервера
- set locked(value: boolean): void - сеттер для блокировки страницы при открытии модального окна

#### Класс CardBasket
Отвечает за отображение карточки в корзине, задавая в карточке данные названия и цены.
В конструктор класса передается DOM элемент темплейта и экземпляр `EventEmitter` для инициации событий. В классе устанавливается слушатель клика на кнопке удаления товара.\
- events: IEvents - экземпляр брокера событий
- title: HTMLHeadingElement - элемент разметки с названием товара
- price: HTMLSpanElement - элемент разметки со стоимостью товара
- deleteButton: HTMLButtonElement - кнопка удаления товара

Методы:
- сеттеры для полей класса

#### Класс CardCatalog 
Отвечает за отображение карточки продукта на главном экране, задавая в карточке данные названия, изображения, категории и стоимости товара. Класс используется для отображения карточек в каталоге.\ 
В конструктор класса передается DOM элемент темплейта и экземпляр `EventEmitter` для инициации событий. В классе устанавливается слушатель клика для генерарции события открытия модального окна карточки товара.\
Поля класса:
- events: IEvents - экземпляр брокера событий
- category: HTMLSpanElement - элемент разметки с название категории
- image: HTMLImageElement - элемент разметки с изображением
- price: HTMLSpanElement - элемент разметки со стоимостью товара
- title: HTMLHeadingElement - элемент разметки с названием товара
- button?: HTMLButtonElement - элемент разметки карточки товара в галлерее, по нажатию на который открывается модальное окно карточки товара

Методы:
- сеттеры для полей класса

#### Класс CardProduct
Отвечает за отображение содержимого карточки с описанием товара, задавая в карточке данные названия, изображения, категории, стоимости и описания товара.\
В конструктор класса передается DOM элемент темплейта и экземпляр `EventEmitter` для инициации событий. В классе устанавливается слушатель клика на кнопку добавления в корзину.\
Поля класса:
- category: HTMLSpanElement - элемент разметки с название категории
- image: HTMLImageElement - элемент разметки с изображением
- price: HTMLSpanElement - элемент разметки со стоимостью товара
- title: HTMLHeadingElement - элемент разметки с названием товара
- description: HTMLParagraphElement - элемент разметки с описанием товара
- buyButton: HTMLButtonElement - кнопка добавления товара в корзину

Методы:
- сеттеры для полей класса

#### Класс Modal
Предназначен для реализации модального окна, в которое может быть выведен любой контент. 
Конструктор принимает селектор, по которому в разметке страницы будет идентифицировано модальное окно и экземпляр класса `EventEmitter` для возможности инициации событий. В классе устанавливается слушатель клика на кнопку закрытия.\
Поля класса:
- closeButton: HTMLButtonElement - кнопка закрытия модального окна
- content: HTMLElement - элемент разметки, который нужно отобразить в модальном окне

Методы:
- open(): void - открывает модальное окно
- close(): void - закрывает модальное окно
- render(data: IModalData): HTMLElement - расширяет родительский метод дополнительно вызывая открытие модального окна

#### Класс Basket 
Предназначен для отображения содержимого шаблона корзины.\
Конструктор принимает DOM элемент темплейта корзины и экземпляр класса `EventEmitter` для инициации событий. В классе устанавливается слушатель клика на кнопку оформления.\ 
Поля класса:
- basketList: HTMLUListElement - элемент списка товаров
- items: HTMLElement[] - массив HTML-элементов карточек
- total: HTMLSpanElement - элемент разметки общей стоимости товаров
- submitButton: HTMLButtonElement - кнопка оформления заказа

Методы:
- set items(items: HTMLElement[]): void - вставляет в разметку массив карточек или выводит текст 'Корзина пуста'
- checkAvailability(items: HTMLElement[]): void - устанавливает доступность кнопки оформления
- confirm(): void - оформляет заказ

#### Класс Payment 
Предназначен для отображения содержимого шаблона формы для ввода методом оплаты и доставки товара.\
Конструктор принимает DOM элемент темплейта корзины и экземпляр класса `EventEmitter` для инициации событий. В классе устанавливаются слушатели на кнопки и поле ввода.\ 
Поля класса:
- events: IEvents - экземпляр брокера событий
- submitButton: HTMLButtonElement - кнопка подтверждения
- errors: HTMLSpanElement - элемент разметки для вывода ошибок заполнения формы
- valid: boolean - параметр доступности кнопки

Методы:
- set valid(isValid: boolean): void - изменяет активность кнопки подтверждения
- set errors(value: string): void - сеттер для вывода ошибок
- onInputChange(field: keyof T, value: string): void - сохраняет введённые данные

#### Класс Contacts
Предназначен для отображения содержимого шаблона формы для ввода электронной почты и телефона пользователя.\
Конструктор принимает DOM элемент темплейта корзины и экземпляр класса `EventEmitter` для инициации событий. В классе устанавливаются слушатели на кнопку и поля ввода.\ 
Поля класса:
- events: IEvents - экземпляр брокера событий
- submitButton: HTMLButtonElement - кнопка подтверждения
- errors: HTMLSpanElement - элемент разметки для вывода ошибок заполнения формы
- valid: boolean - параметр доступности кнопки

Методы:
- set valid(isValid: boolean): void - сеттер изменяет активность кнопки подтверждения
- set errors(value: string): void - сеттер для вывода ошибок
- onInputChange(field: keyof T, value: string): void - сохраняет введённые данные

#### Класс OrderSuccess 
Предназначен для отображения содержимого шаблона успешного оформления заказа.\
Конструктор принимает DOM элемент темплейта корзины и экземпляр класса `EventEmitter` для инициации событий. В классе устанавливаются слушатели на кнопку и поля ввода.\ 
Поля класса:
- events: IEvents - экземпляр брокера событий
- successButton: HTMLButtonElement -  кнопка "За новыми покупками!" закрывает модальное окно
- total: HTMLParagraphElement - элемент разметки общей стоимости заказа

Методы:
- setTotalCost(total: number): void - записывает в элемент разметки общую стоимости заказа


### Слой презентера

#### Класс AppApi
Принимает в конструктор экземпляр класса Api и предоставляет методы реализующие взаимодействие с бэкендом сервиса.
Методы:
- getCards(): Promise<IProduct[]> - получение массива карточек товаров с сервера
- sendOrder(TOrder): {id: string, total: number} - отправка заказа на сервер

#### Взаимодействие компонентов
Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.\
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

*Список всех событий, которые могут генерироваться в системе:*\
*События изменения данных (генерируются классами моделями данных)*
- `cards:load` - загрузка массива карточек товаров с сервера
- `basket:changed` - изменение состава корзины
- `user:changed` - изменение данных пользователя
- `order:success` - получение ответа об успешном заказе от сервера и очистка карзины


*События, возникающие при взаимодействии пользователя с интерфейсом (генерируются классами, отвечающими за представление)*
- `product:open` - открытие модального окна с описанием продукта
- `basket:open` - открытие модального окна корзины
- `payment:open` - открытие модального окна с формой ввода способа оплаты и адреса
- `contacts:open` - открытие модального окна с формой ввода электронной почты и телефона
- `basket:add` - добавление товара в корзину
- `basket:remove` - удаление товара из корзины
- `edit-payment:input` - изменение данных в форме способа оплаты и адреса
- `edit-contacts:input` - изменение данных в форме электронной почты и телефона
- `edit-payment:submit` - сохранение способа оплаты и адреса пользователя в модальном окне
- `edit-contacts:submit` - сохранение электронной почты и телефона пользователя в модальном окне

Пример работы презентера:
1. Пользователь нажимает иконку удаления товара из корзины: в классе CardBasket срабатывает метод слушатель на элементе deleteButton и генерирует событие emit(`basket:remove`, ...).
2. В файле презентера `index.ts` срабатывает событие on(`basket:remove`, ...) и в классе BasketModel вызывается метод remove(). 
3. В классе BasketModel выполняется удаление элемента из массива (поле items), выполняется перерасчёт количества товаров и суммы (методы getTotalCost() и countItems(), после чего генерируется событие emit(`basket:changed`, ...) с новыми данными.
4. В файле презентера обрабатывается событие on(`basket:changed`, ...) и вызывается в классе Component метод render расширения CardBasket.
5. Представление модального окна корзины перерисовывается с новми данными.
